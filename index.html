<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mandatberegneren</title>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <link href="mandat.css" rel="StyleSheet" type="text/css">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(function () {
            $('#main').hide();
            $("#Oppdater").click(function () {
                hentFraAPI();
            });
            $("#FylkesVelger").change(function () {
                hentFraAPI();
            });
            hentFraAPI();
        });

        function finnDivisorer(antallMandater) {
            let divisorer = [];
            divisorer.push(1.4);
            for (let i = 2; i < (antallMandater + 1); i++) {
                divisorer.push(i * 2 - 1);
            }
            return divisorer;
        }

        function finnDelingstall(stemmer, divisorer) {
            let delingstall = [];
            for (parti in stemmer) {
                let kvotienter = [];
                for (let i = 0; i < divisorer.length; i++) {
                    const dTall = stemmer[parti] / divisorer[i];
                    kvotienter.push(stemmer[parti] / divisorer[i]);
                }
                delingstall[parti] = kvotienter;
            }
            return delingstall;
        }

        function generer(stemmer) {
            $("#Mandatliste").empty();
            const antallMandater = parseInt($("#AntallRep").text());

            const divisorer = finnDivisorer(antallMandater);
            const delingstall = finnDelingstall(stemmer, divisorer);

            let mandater = [];

            let delingstallMandat = [];
            let antallMandeterParti = [];
            for (i = 0; i < antallMandater; i++) {
                delingstallMandat[i] = 0;
                let partiMandat = "";
                for (parti in delingstall) {
                    const mandaterParti = antallMandeterParti[parti] === undefined ? 0 : antallMandeterParti[parti];
                    if (delingstall[parti][mandaterParti] > delingstallMandat[i]) {
                        delingstallMandat[i] = delingstall[parti][mandaterParti];
                        partiMandat = parti;
                    }
                }
                antallMandeterParti[partiMandat] = antallMandeterParti[partiMandat] === undefined ? 1 : antallMandeterParti[partiMandat] + 1;
                mandater[i] = partiMandat;
            }

            let teller = 0;
            let mandatlisteParti = [];
            for (i = 0; i < mandater.length; i++) {
                if (mandatlisteParti[mandater[teller]] === undefined) {
                    mandatlisteParti[mandater[teller]] = [];
                }
                mandatlisteParti[mandater[teller]].push(teller + 1);
                teller++;
            }
            let tabellString = "<table id=\"DelingstallTabell\" class=\"table table-striped table-bordered\"><thead  class=\"thead-inverse\"><tr><th class=\"mandat\">Mandat</th>";
            for (parti in delingstall) {
                tabellString += "<th>" + parti + "</th>";
            }
            tabellString += "</tr></thead><tbody>";
            for (i = 0; i < antallMandater; i++) {
                tabellString += "<tr>";
                tabellString += "<td class=\"mandat\">" + (i + 1) + "</td>";
                for (parti in delingstall) {
                    let kvot = delingstall[parti][i].toFixed(2);
                    let cellClass = "ikkeMandat";
                    if (mandatlisteParti[parti] !== undefined && mandatlisteParti[parti][i] !== undefined) {
                        kvot += "(" + mandatlisteParti[parti][i] + ")";
                        cellClass = "mandat";
                        if (mandatlisteParti[parti][i] === antallMandater) {
                            cellClass += " sisteMandat";
                        }
                    }
                    tabellString += "<td class=\"" + cellClass + "\">" + kvot + "</td>";
                }
                tabellString += "</tr>";
            }
            tabellString += "</tbody></table>";
            $("#Mandatliste").append(tabellString);
            merkDelingstallUtenMandat();
        }

        function merkDelingstallUtenMandat() {
            let max;
            $("#DelingstallTabell > tbody > tr > td").filter(".ikkeMandat").each(function (index) {
                if (max === undefined || parseFloat($(this).text()) > parseFloat(max.text())) {
                    max = $(this);
                }
            });
            max.addClass("maxUtenMandat");
        }

        function hentFraAPI() {
            $('#loading').show();
            const apiUrl = "https://cors-anywhere.herokuapp.com/https://valgresultat.no/api"+$("#FylkesVelger option:selected").val();

            fetch(apiUrl).then(r => r.json())
                .then(data => oppdaterData(data))

        }

        function oppdaterData(data) {
            const mandater = (data.mandater.antall) - 1;
            $("#AntallRep").text(mandater);
            $("#StemmetabellBody").empty();

            data.partier.sort(function (a, b) {
                return b.stemmer.resultat.antall.total - a.stemmer.resultat.antall.total;
            });
            data.partier.forEach(function (parti) {
                if (parti.id.partikategori == 1) {
                    const stemmer = parti.stemmer.resultat.antall.total;
                    const partinavn = parti.id.navn;
                    const partirad = '<tr class="stemmetallRad">'
                        + '<td class="partinavn">' + partinavn + '</td>'
                        + '<td class="stemmetall">' + stemmer + '</td>'
                        + '</tr>';
                    $("#Stemmetabell > tbody").append(partirad);
                }
            });
            genTabell();
            $('#loading').hide();
            $('#main').show();
        }

        function genTabell() {
            let stemmer = [];
            $("#Stemmetabell").find(".stemmetallRad").each(function (index) {
                const partinavn = $(this).find(".partinavn").text();
                stemmer[partinavn] = $(this).find(".stemmetall").text();
            });

            generer(stemmer);
        }

    </script>
</head>
<body>
<div id="loading"></div>
<div id="main">
    <h1>Mandatberegning</h1>
    <label for="FylkesVelger">Fylke</label>
    <select id="FylkesVelger">
        <option value="/2013/st/01">Østfold</option>
        <option value="/2013/st/02">Akershus</option>
        <option value="/2013/st/03">Oslo</option>

        <option value="/2013/st/04">Hedmark</option>
        <option value="/2013/st/05">Oppland</option>
        <option value="/2013/st/06">Buskerud</option>
        <option value="/2013/st/07">Vestfold</option>
        <option value="/2013/st/08">Telemark</option>
        <option value="/2013/st/09">Aust-Agder</option>
        <option value="/2013/st/10">Vest-Agder</option>
        <option value="/2013/st/11">Rogaland</option>
        <option value="/2013/st/12">Hordaland</option>
        <option value="/2013/st/14">Sogn og Fjordane</option>
        <option value="/2013/st/15">Møre og Romsdal</option>
        <option value="/2013/st/16" selected>Sør-Trøndelag</option>
        <option value="/2013/st/17">Nord-Trøndelag</option>
        <option value="/2013/st/18">Nordland</option>
        <option value="/2013/st/19">Troms Romsa</option>
        <option value="/2013/st/20">Finnmark Finnmárku</option>

    </select>
    <dl>
        <dt>Antall mandater</dt>
        <dd id="AntallRep"></dd>
    </dl>
    <div>
        <table id="Stemmetabell" class="table table-striped table-bordered">
            <thead class="thead-inverse">
            <tr>
                <th>Parti</th>
                <th class="stemmetall">Stemmer</th>
            </tr>
            </thead>
            <tbody id="StemmetabellBody">
            </tbody>
        </table>
    </div>
    <div id="Mandatliste" class="table-responsive"></div>
    <button id="Oppdater">Oppdater stemmetall</button>
</div>
</body>
</html>