<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Sainte-Lagu&euml;s metode</title>
    <link href="mandat.css" rel="StyleSheet" type="text/css">

    <script type="text/javascript" src="http://code.jquery.com/jquery.js"></script>
    <script type="text/javascript">
        $(function () {
            $("Oppdater").click(function () {
                hentFraAPI();
            });
            hentFraAPI();
        });

        function finnDivisorer(antallMandater) {
            let divisorer = [];
            divisorer.push(1.4);
            for (let i = 2; i < (antallMandater + 1); i++) {
                divisorer.push(i * 2 - 1);
            }
            return divisorer;
        }

        function finnDelingstall(stemmer, divisorer) {
            let delingstall = [];
            for (parti in stemmer) {
                let kvotienter = [];
                for (let i = 0; i < divisorer.length; i++) {
                    const dTall = stemmer[parti] / divisorer[i];
                    kvotienter.push(stemmer[parti] / divisorer[i]);
                }
                delingstall[parti] = kvotienter;
            }
            return delingstall;
        }

        function generer(stemmer) {
            $("#MandatlisteDiv").empty();
            const antallMandater = parseInt($("#AntallRep").text());

            const divisorer = finnDivisorer(antallMandater);
            const delingstall = finnDelingstall(stemmer, divisorer);

            let mandater = [];

            let delingstallMandat = [];
            let antallMandeterParti = [];
            for (i = 0; i < antallMandater; i++) {
                delingstallMandat[i] = 0;
                let partiMandat = "";
                for (parti in delingstall) {
                    const mandaterParti = antallMandeterParti[parti] === undefined ? 0 : antallMandeterParti[parti];
                    if (delingstall[parti][mandaterParti] > delingstallMandat[i]) {
                        delingstallMandat[i] = delingstall[parti][mandaterParti];
                        partiMandat = parti;
                    }
                }
                antallMandeterParti[partiMandat] = antallMandeterParti[partiMandat] === undefined ? 1 : antallMandeterParti[partiMandat] + 1;
                mandater[i] = partiMandat;
            }

            let teller = 0;
            let mandatlisteParti = [];
            for (i = 0; i < mandater.length; i++) {
                if (mandatlisteParti[mandater[teller]] === undefined) {
                    mandatlisteParti[mandater[teller]] = [];
                }
                mandatlisteParti[mandater[teller]].push(teller + 1);
                teller++;
            }
            let tabellString = "<table id=\"DelingstallTabell\"><thead><tr><th class=\"mandat\">Mandat</th>";
            for (parti in delingstall) {
                tabellString += "<th>" + parti + "</th>";
            }
            tabellString += "</tr></thead><tbody>";
            for (i = 0; i < antallMandater; i++) {
                tabellString += "<tr>";
                tabellString += "<td class=\"mandat\">" + (i + 1) + "</td>";
                for (parti in delingstall) {
                    let kvot = delingstall[parti][i].toFixed(2);
                    let cellClass = "ikkeMandat";
                    if (mandatlisteParti[parti] !== undefined && mandatlisteParti[parti][i] !== undefined) {
                        kvot += "(" + mandatlisteParti[parti][i] + ")";
                        cellClass = "mandat";
                        if (mandatlisteParti[parti][i] === antallMandater) {
                            cellClass += " sisteMandat";
                        }
                    }
                    tabellString += "<td class=\"" + cellClass + "\">" + kvot + "</td>";
                }
                tabellString += "</tr>";
            }
            tabellString += "</tbody></table>";
            $("#MandatlisteDiv").append(tabellString);
            merkDelingstallUtenM();
        }

        function merkDelingstallUtenM() {
            let max;
            $("#DelingstallTabell > tbody > tr > td").filter(".ikkeMandat").each(function (index) {
                if (max === undefined || parseFloat($(this).text()) > parseFloat(max.text())) {
                    max = $(this);
                }
            });
            max.addClass("maxUtenMandat");
        }

        function hentFraAPI() {
            const apiUrl = "https://cors-anywhere.herokuapp.com/https://valgresultat.no/api/2013/st/s%C3%B8r-tr%C3%B8ndelag";

            fetch(apiUrl).then(r => r.json())
                .then(data => oppdaterData(data))

        }

        function oppdaterData(data) {
            const mandater = (data.mandater.antall) - 1;
            $("#AntallRep").text(mandater);

            data.partier.sort(function (a, b) {
                return b.stemmer.resultat.antall.total - a.stemmer.resultat.antall.total;
            });
            data.partier.forEach(function (parti) {
                if (parti.id.partikategori == 1) {
                    const stemmer = parti.stemmer.resultat.antall.total;
                    const partinavn = parti.id.navn;
                    const partirad = '<tr class="stemmetallRad">'
                        + '<td class="partinavn">' + partinavn + '</td>'
                        + '<td class="stemmetall">' + stemmer + '</td>'
                        + '</tr>';
                    $("#Stemmetabell > tbody").append(partirad);
                }
            });
            genTabell();
        }

        function genTabell() {
            let stemmer = [];
            $("#Stemmetabell").find(".stemmetallRad").each(function (index) {
                const partinavn = $(this).find(".partinavn").text();
                stemmer[partinavn] = $(this).find(".stemmetall").text();
            });

            generer(stemmer);
        }

    </script>
</head>
<body>
<dl>
    <dt>Antall representanter</dt>
    <dd id="AntallRep"></dd>
</dl>
<table id="Stemmetabell">
    <thead>
    <tr>
        <th>Parti</th>
        <th>Stemmer</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<button id="Oppdater">Oppdater stemmetall</button>
<div id="MandatlisteDiv"></div>
</body>
</html>